# Writeup Working at COMPFEST Shop

### Primitives
UAF

### Techniques
Safe linking bypass, House of spirit, Tcache poisoning, ROP

### Steps
#### 1. Leak heap
Alloc size yang sama 2 kali, lalu free semua. Karena ada UAF dan value tidak direset, fd pointer dari chunk yang sudah di free masih ada. Sehingga, cukup alloc 1 kali lagi dan isi nama dengan 1 char selain NULL byte, sehingga bisa mendapatkan fd pointer yang lama meskipun byte terakhirnya kita overwrite. Selain itu fd pointer berisi address heap yang encrypted berkat efek dari safe linking protection. Namun kedua hal tersebut bukan masalah karena kita tetap dapat bisa melakukan decrypt safe linking untuk mendapatkan base heap address.
#### 2. Leak libc
Leak libc dengan membuat unsorted chunk. Karena kita dapat delete() berulang kali, maka kita dapat mengoverwrite pointer name dengan arbitrary address, lalu lakukan delete() untuk dapat melakukan free() pada arbitrary address. Hal tersebut dapat kita manfaatkan untuk melakukan teknik house of spirit untuk membuat fake smallbin chunk yang overlap, sehingga keynya dapat kita ubah. Sehingga kita dapat melakukan free() berulang kali pada fake smallbin chunk tsb sehingga kita dapat mengisi penuh tcache bin. Lalu kita dapat melakukan free() pada chunk yang kita inginkan untuk mendapatkan unsorted smallbin chunk, yang kita gunakan untuk mendapatkan address libc.
#### 3. Leak stack
Buat overlapping chunk mirip seperti stage 2 untuk overwrite pointer name yang mengarah pada environ. Lalu tinggal view() pada chunk tersebut untuk mendapatkan stack address.
#### 4. ROP
Buat overlapping chunk mirip seperti stage 2 agar bisa melakukan tcache poisoning. Tcache poisoning kita gunakan untuk overwrite rip dengan rop chain untuk mendapatkan shell.

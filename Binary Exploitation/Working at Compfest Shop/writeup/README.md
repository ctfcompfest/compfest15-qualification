# Writeup Working at COMPFEST Shop

### Primitives
UAF

### Techniques
Safe linking bypass, House of spirit, Tcache poisoning, FSOP, ROP

### Steps
#### 1. Leak heap
Alloc size yang sama 2 kali, lalu free semua. Karena ada UAF dan value tidak direset, fd pointer dari chunk yang sudah di free masih ada. Sehingga, cukup alloc 1 kali lagi dan isi nama dengan 1 char selain NULL byte, sehingga bisa mendapatkan fd pointer yang lama meskipun byte terakhirnya kita overwrite. Selain itu fd pointer berisi address heap yang encrypted berkat efek dari safe linking protection. Namun kedua hal tersebut bukan masalah karena kita tetap dapat bisa melakukan decrypt safe linking untuk mendapatkan base heap address.
#### 2. Leak libc
Leak libc dengan membuat unsorted chunk. Karena kita dapat delete() berulang kali, maka kita dapat mengoverwrite pointer name dengan arbitrary address, lalu lakukan delete() untuk dapat melakukan free() pada arbitrary address. Hal tersebut dapat kita manfaatkan untuk melakukan teknik house of spirit untuk membuat fake smallbin chunk yang overlap, sehingga keynya dapat kita ubah. Sehingga kita dapat melakukan free() berulang kali pada fake smallbin chunk tsb sehingga kita dapat mengisi penuh tcache bin. Lalu kita dapat melakukan free() pada chunk yang kita inginkan untuk mendapatkan unsorted smallbin chunk, yang kita gunakan untuk mendapatkan address libc.
#### 3. Leak stack
Karena kita sudah menggunakan view() 2 kali, kita tidak dapat memanfaatkannya lagi untuk leak. Sehingga lakukan FSOP pada stdout untuk leak. Buat overlapping chunk mirip seperti stage 2 agar bisa melakukan tcache poisoning. Tcache poisoning kita gunakan untuk FSOP dengan mengubah file structure stdout sehingga akan melakukan leak pada environ, yang mana berisi address stack. Untuk detail terkait leak menggunakan FSOP dapat melihat https://vigneshsrao.github.io/posts/babytcache/
#### 4. ROP
Karena sudah mendapatkan stack leak, maka kita mengetahui address rip. Buat overlapping chunk mirip seperti stage 2 agar bisa melakukan tcache poisoning. Tcache poisoning kita gunakan untuk overwrite rip dengan rop chain untuk mendapatkan shell. Ingat bahwa terdapat seccomp yang memblokir execve(), sehingga kita harus melakukan rop chain dengan open-read-write. Karena ukuran chunk terbatas, maka rop chain dapat kita pecah.

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void init() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
}

struct item {
    long price;
    char* name;
};

int N = 10;
struct item* items[10];
int itemNameSize[10];
int isAllocated[10];

long read_long() {
    char buf[0x20];
    read(0, buf, 16);
    return atol(buf);
}

void add_item() {
    printf("At which slot? (0 - %d): ", N - 1);

    int idx;
    idx = read_long();
    if (idx < 0 || idx >= N) {
        puts("[❗] Sorry, you are not allowed to to that.");
        return;
    }

    printf("Item name size: ");
    itemNameSize[idx] = read_long();
    if (itemNameSize[idx] > 0x78) {
        puts("[❗] Pardon me, but is that a name or a novel?");
        return;
    }

    items[idx] = malloc(sizeof(struct item));
    items[idx]->name = malloc(itemNameSize[idx]);

    printf("Item price: ");
    items[idx]->price = read_long();

    printf("Item name: ");
    read(0, items[idx]->name, itemNameSize[idx]);

    isAllocated[idx] = 1;
    puts("[✅] Item added successfully.");
}

void edit_item() {
    printf("At which slot? (0 - %d): ", N - 1);

    int idx;
    idx = read_long();
    if (idx < 0 || idx >= N || !isAllocated[idx]) {
        puts("[❗] Sorry, you are not allowed to to that.");
        return;
    }

    printf("New item price: ");
    items[idx]->price = read_long();

    printf("New item name: ");
    read(0, items[idx]->name, itemNameSize[idx]);

    puts("[✅] Item edited successfully.");
}

void delete_item() {
    printf("At which slot? (0 - %d): ", N - 1);

    int idx;
    idx = read_long();
    if (idx < 0 || idx >= N) {
        puts("[❗] Sorry, you are not allowed to to that.");
        return;
    }

    free(items[idx]->name);
    free(items[idx]);
    isAllocated[idx] = 0;

    puts("[✅] Item deleted successfully.");
}

void view_item() {
    printf("At which slot? (0 - %d): ", N - 1);

    int idx;
    idx = read_long();
    if (idx < 0 || idx >= N || !isAllocated[idx]) {
        puts("[❗] Sorry, you are not allowed to to that.");
        return;
    }

    printf("Item price: %ld\n", items[idx]->price);
    printf("Item name: %s\n", items[idx]->name);
}

int menu() {
    puts("");
    puts("=-=-=-=-= [Compfest Shop Sim v1.0.0 - MENU] =-=-=-=-=");
    puts("What do you want to do?");
    puts("1. Add item");
    puts("2. Delete item");
    puts("3. Edit item");
    puts("4. View item");
    puts("5. Exit");
    printf("> ");

    int choice;
    choice = read_long();
    return choice;
}

void introduction() {
    puts("???       : Umm hey! So, you must be the new worker here right?");
    puts("???       : I\'m the manager here, nice to meet you.");
    puts("Manager   : You\'re still new here, so I\'ll work you in our company's simulator first.");
    puts("Manager   : Here you are in charge of managing the items in our shop.");
    puts("Manager   : You can add, delete, edit, and view items. But there are only 10 slots of items.");
    puts("Manager   : In order to make this a lot easier for you, there aren\'t any customers here.");
    puts("Manager   : Well, isn\'t that great! You can learn how to manage items freely without any pressure.");
    puts("Manager   : Just make sure you don't do anything too unusual or, worse, accidentally break anything, okay?");
    puts("Manager   : Well then, I must be going. Good luck, and most importantly, have some fun!");
}

int main() {
    init();
    introduction();

    while (69) {
        int choice = menu();
        switch (choice) {
            case 1:
                add_item();
                break;
            case 2:
                delete_item();
                break;
            case 3:
                edit_item();
                break;
            case 4:
                view_item();
                break;
            case 5:
                puts("Bye.");
                return 0;
                break;
            default:
                puts("Invalid choice.");
                break;
        }
    }
}
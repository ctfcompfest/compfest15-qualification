# e2echat

We are given a pcapng file, as well as the source code for the website. Looking at the website, and the network tab gives us some clue of what is happening
![](https://d.rorre.xyz/DEayVaTk0/chrome_Dhw18kd2nF.png)

All the communication is done via websocket, so let's only focus on that aspect of communication and ignore all irrelevant packets.

We are left with these packets:
![](https://d.rorre.xyz/rDEYCsrMX/Wireshark_E4W3tIq0HW.png)

Still quite a lot, so let's explore the website a bit. Let's try logging into two users and start a conversation!
After initiating a conversation, we seem to send a message, and also receive another message from the websocket connection.

![](https://d.rorre.xyz/OuW2KNz1F/chrome_JZo0zY9Xpe.png)

Here's the message we send
```
{
  "type": "init",
  "data": {
    "fromUsername": "ren",
    "targetUsername": "bob",
    "type": "v",
    "value": "somebignumber"
  }
}
```

And the message we receive
```
{
  "type": "init",
  "data": {
    "fromUsername": "bob",
    "targetUsername": "ren",
    "type": "v",
    "value": "anotherbignumber"
  }
}
```

Coolcool, we can make a guess on what's happening, maybe some auth exchange? maybe its to confirm that the user is available?
Making a new message to an invalid user makes it say "Still exchanging keys", so clearly, that's key exchange!

Moving on, let's figure out how message works, let's receive and send a message. Here are the messages we get:
![](https://d.rorre.xyz/inSsQnt77/chrome_aqT63QnBrs.png)

The message seems to be the same, it looks like this:
```
{
  "type": "message",
  "data": {
    "fromUsername": "ren",
    "targetUsername": "bob",
    "id": "1683724641664",
    "message": "bignumber"
  }
}
```

Now that we have known the general idea of the app, let's look into the source code. We can go to the source tab and reformat the js file. Let's look at what "init" does:
```js
h = _.useCallback(async y => {
    if (y.type != "init")
        return;
    const k = y.data.fromUsername,
        j = BigInt(y.data.value);
    if (j < 2n ** 1024n) {
        const c = j + 2n ** 1024n,
            d = await ps(1024),
            v = c * d;
        r({
                type: "init",
                data: {
                    fromUsername: t,
                    targetUsername: k,
                    type: "v",
                    value: v.toString()
                }
            }),
            a(S => {
                const C = {
                    ...S
                };
                return C[k] = {
                        p: c,
                        q: d,
                        n: v
                    },
                    C
            })
    } else
        a(c => {
            const d = {
                    ...c
                },
                v = d[k].p,
                S = BigInt(y.data.value);
            return d[k] = {
                    p: v,
                    n: S,
                    q: S / v
                },
                d
        });
    u(c => {
        const d = {
            ...c
        };
        return d[k] = [],
            d
    })
})
```

Looking at it, there are two parts of this code, if init is < 2^1024, and else. There is a special data structure here as well, that is `{p: x, n: x, q: x}`. Hmmh, looks like RSA.
Looking around the source code confirms that this code is indeed for exchanging, as it is used to update credentials.

So, let's dissect each cases. What if its less than 2^1024? Here's the cleaned and refactored clean code
```
h = _.useCallback(async data => {
    if (data.type != "init")
        return;
    const fromUsername = data.data.fromUsername,
        bignum = BigInt(data.data.value);
    if (bignum < 2n ** 1024n) {
        const c = bignum + 2n ** 1024n,
            d = await ps(1024),
            v = c * d;
        r({
                type: "init",
                data: {
                    fromUsername: t,
                    targetUsername: fromUsername,
                    type: "v",
                    value: v.toString()
                }
            }),
            updateCredentials(credentials => {
                const C = {
                    ...credentials
                };
                return C[fromUsername] = {
                        p: c,
                        q: d,
                        n: v
                    },
                    C
            })
    } else
        // Else block and the rest snipped
})
```
What it seems to do is to generate a prime number, then calculate c * d. So that would be the `n` in RSA, it seems. Therefore the data sent is the `p`. Let's look at the else block.
```
h = _.useCallback(async data => {
    if (data.type != "init")
        return;
    const fromUsername = data.data.fromUsername,
        bignum = BigInt(data.data.value);
    if (bignum < 2n ** 1024n) {
        // snip
    } else
        updateCredentials(c => {
            const d = {
                    ...c
                },
                v = d[k].p,
                S = BigInt(y.data.value);
            return d[k] = {
                    p: v,
                    n: S,
                    q: S / v
                },
                d
        })
});
```
Yeah, it only divides `n` by `p`, which results in `q`. So the data we receive is `n`, therefore we can confirm that this is indeed the `p`, `q`, and `n` in RSA.

Let's go back to wireshark, and get our sweet numbers!

- Frame 133: We get our first init, its negative, so we get our `p` by adding that number with 2^1024.
  ```
  v = -7299804857866186049608636249911276974316221356885564924813200798632601749512936134474868504002598110168417917289001843068808047274958302035161692792293356795518628693822216634866552094727010434765321416311549113631140703833908942752189035206917401517558287310182779833019854551585269459318196217467998181217
  p = v + 2^1024 = 172469508628365404723321882828991196387481476537345092348616880359100074055988026998233608818404937910951695962582391514589981721539458320457685737847180767582249264731043268641435667506519083684687761535773456655207009978508553938721724075333909835645792223374403518406927391386894446845517160112156225955999
  ```
- Frame 137: We get our second init, and its positive, so we get our `n`, so let's get our `p` by doing `n/p`.
  ```
  q = 168821530401014377498926249300212052225135816359532655749676143112044919083558132197614354568344008631310003517841578723416412200983091219583619044350606025924505249644858240110488337414669091914763963199704753063884037165883308315027707316256885827956897945290601334876343401559107292891529255547858357576839
  ```

We are still missing our `d` and `e`. Going around, we can see that `d` is `0x10001`, take a look at this function:
```
function Jp(e, t) {
    const n = new TextEncoder;
    let r = Gp(n.encode(e));
    return pl(r, 0x10001n, t)
}
```

Now that we've got our `e`, we can calculate `d` with given information:
```
totient = (p-1)*(q-1)
d = pow(e, -1, totient)
```

Finally, we can decode all messages.
```
p = 168821530401014377498926249300212052225135816359532655749676143112044919083558132197614354568344008631310003517841578723416412200983091219583619044350606025924505249644858240110488337414669091914763963199704753063884037165883308315027707316256885827956897945290601334876343401559107292891529255547858357576839
n = 29116566394151601664610069303747715855356214872963782920725074996047493096331676476821431269056879517823568772536760855620490099049527544187171971509815862258155490313925620884484686048228786130101120541047448887611117692445172587770626218247199123180730416521425181400941752015331410376003413756444127437320157959024490402548889859439942842331583156654429139341276215645481654587492807690300712464491524456421320753644630010989754029779101002723502469769594340720717444312470173187521567316632892142551636626491085320470170088955843101437623634822355706540812434214777107783270133737738593144570052255451657875507161
q = n // p
e = 0x10001

totient = (p - 1) * (q - 1)
d = pow(e, -1, totient)

while True:
    c = int(input("Num: "))
    plain = pow(c, d, n)
    while plain > 0:
        print(chr(plain % 256), end="")
        plain //= 256
    print()
```

Simply run all the numbers on packet 158-264 and we get the conversation:
```
Num: 3632788507148418529006889428869509656171243977620777623836618098235067706406455819243260342510654641547826983820249206673371372405174301817890630379259560058154980219102840844686260891870851655086710376648028635295977838211968649366271647704803259995356450460574318092206072387537473146741532828614488389751974847179773056679530512909887228507125822467511394900688261278684332004668391970327129899997286663422204343056817218410799196493142321104990247950636710633848543188071375233382773256889006697199044306306135152240195138979985706109188782609936829672548798113942675440020154712082554264793361214829491439745400
Heyo, you got the stuffs?
Num: 16933447801662887870119852964720377371216954236996294857522399514142220176045378344738146138733100548812257897014534848650889491467448362192329273360236484348801690459092180048470789992655291351302766527578738070791532834887681820306189934779637424314357501765123205814099132609193437446089222873579644173104090433269801585098035940593417073925395769244039356918644715319572646683354168308115669968966384404347751099910607894607160218826888832323461447566154986141870133114538920510186606705284197209524630296392666454031050571246972371940387084374192885810368314689000121663675324662171827777550409137287586779946207
I don't know what you're talking about.
Num: 9599108131523778421374362891273568649618184093689084607921321519503819987919933805465983451365024391613480401981869613083940483359139198432038816054049265280605959383245340714626780022696898655742363609825802343767022416846356323862393565961553488760191186025066541840931393687512486667984580931956769240450448178766352166016028386363769231176672706784161283428411842123387267023143148303548157986820524405510795366579159497001142776142947759625144041575436972883554870097557284595061136227828668517158233557971175799810347656002567102262258293270039883087246585945232821604527939387020762619239180451022384706110752
Don't be annoying, you know it's me.
Num: 10759128040934552042330786494370327220310465059734557898106426331483384830774920336881694650021739126051532987868928905834271147376891588229711327684800756118023383193867685250019004287402817203186963073672891663169513145871702063603274910180719885920127166647290634283739777349734647905660856976604787612364350510676426675286908932002135297592854551444577259164819757572360981045150564221028595978057067116221396935181697784078425081251023548434313448271048847767462228719784714758256760576949454573775282064370613783424874483411040327531091225486701249588418067535704762179229313716213259035758503944320096714371661
I still don't know what you're talking about.
Num: 5033094523853792311852529456179811557880524393434955476383808045012363675028085818748407982394679097737723510974587340376427824483087992807450120892677933709297473091410826535810945147011005409663552125957642362082722215534163728776340054000338326508924181405813418197405079773684319880521492485156104940642422517214754611547573223005178352525299403358263133689986579133647338995863524700363470809591952237979583941212950608644391306276114756045697072361203888512001837895143699272947674460909599050727896812068998496172972448043291330268267599423978509079671845393225855181434714852657465321176595945760956505879259
Tch, COMPFEST15{tH4T5_n0T_H0w_y0u_3XchAnGe_KeYS!!}
Num: 21908299165625487770286388235676085807884847742262423161189177254276402337046304962174103671926712120304527421591622642866625195421444134966777822323177401724812053209838398588501225805462129451675120186915801138065156265702972050521853386950319039998014278005943680821003666503440205985288054452409895267795199593744952018467226347186185303886111152783734464462949392140281170903976400190056517734521424032901526770175378215336375802508329940657650323184132480480104942805834958585303773694418149095751481553892786728569636580557523505699601888655592139396764781180565254778012222461909764637435174024070076080875146
Alright, here are the catnips.
Num: 28926904137924643820811591921240098398801453121742466005662652665980263444398795681002113884957220908051376607534072826419070056198247627973801589890878346131182633113391705206455447814090191637546426445645829337651393586263747905697036342245722565796948884985251717558995396325259939855751159033934367193815799009117093019573244791138143818152885108870164251642743402055853433825533879346170540535652341811951465935232104230435726873287392942520477596529379660374838971014292306284493198696485808573861062027594509799398140390848058311660163660737465577118503520203377160031812000941458697841435071639019930031711708
Thanks, pleasure doing business with you.
```
